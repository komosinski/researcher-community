{% extends 'base.html' %}


{% set api_users_url = url_for('api.get_users', _external=True)%}

{% block styles %}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}


{% block content %}

<div>
    <h3>Edit {{tag.name}} tag members</h3>
</div>

<select class="js-data-example-ajax" id="selectUsers" style="width: 50%;"></select>


<div id="added_users">

</div>

<br>

<button id="save" class="large-button main-button">Save</button>



<script>
  $(".js-data-example-ajax").select2({
    ajax: {
      url: "{{api_users_url}}",
   
      dataType: 'json',
      delay: 250,
      data: function(params) {
        return {
          q: params.term, // search term
          page: params.page || 1
        };
      },
      processResults: function(data, params) {
        params.page = params.page || 1;

        var data_formated = $.map(data.results, function (obj) {
          obj.text = obj.first_name +' '+ obj.second_name; // replace name with the property used for the text
          return obj;
        });
        return {
          results: data_formated,
          pagination: {
            more: data.pagination.more
          }
        };
      },
      cache: false
    },
    placeholder: 'Search for a users',
    minimumInputLength: 2,
    templateResult: formatResult
  });
  
  function formatResult(result) {

    var $container = $(
    "<div class='select2-result-repository clearfix'>" +
      "<div class='select2-result-repository__avatar'><img src='" + result.profile_img_url + "' style='height: 3vw;'/></div>" +
      "<div class='select2-result-repository__meta'>" +
        "<div class='select2-result-repository__title'></div>" +
        "<div class='select2-result-repository__description'></div>" +
      "</div>" +
    "</div>"
  );

  $container.find(".select2-result-repository__title").text(result.text);
  $container.find(".select2-result-repository__description").text(result.affiliation);

  return $container;

  };

  function createNewUserRow(user, row_id){
    return `<div id="${row_id}">`+
           `<input type="hidden" value='${user.id}'>`+
           `<img src='${user.profile_img_url}' style='height: 3vw;'/>`+
            `<a href='${user.profile_url}' target="_blank">${user.text}</a>`+
             " "+
            `${user.affiliation}`+
            `<a href="javascript:void(0);" class="remove-input" title="Remove input"><img src={{url_for('static', filename='res/del.png')}}/></a></div>`;
  }

  $(document).ready(function(){
  
    let startId = 0;
 
    var max_input_fields = 10;
    var input_wrapper = $('#added_users');
    var add_input_count = 0; 
  
    var users_ids = new Set();

    $(input_wrapper).on('click', '.remove-input', function(e){
        e.preventDefault();
        console.log( $(this).find('input').val() );
       
        $(this).parent('div').remove();

        add_input_count--;
        users_ids.delete(1);
    });

    $('#selectUsers').on('select2:select', function (e) {
      var data = e.params.data;
      if( users_ids.has(data.id)){
          alert("User is already added");
      }
      else{
        add_input_count+=1;
        users_ids.add(data.id);
        $("#added_users").append(createNewUserRow(data, add_input_count));
      }

   
      $('#selectUsers').val(null).trigger('change');
    });



    });




    $( "#save" ).on('click', function(e) {
      

    });


</script>




{% endblock %}

